<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codenames Online</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: #4cc9f0; margin-bottom: 10px; }
        .room-info { 
            background: #16213e; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            text-align: center;
        }
        #roomDisplay { 
            font-family: monospace; 
            font-size: 1.5em; 
            color: #f72585; 
            font-weight: bold;
        }
        .status {
            padding: 15px; 
            border-radius: 10px; 
            margin: 15px 0;
            background: #0f3460; 
            text-align: center;
            transition: all 0.3s;
        }
        .status.connected { background: #2a9d8f; }
        .status.error { background: #e63946; }
        
        /* –ò–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å */
        #gameArea { margin-top: 30px; }
        .board {
            display: grid; 
            grid-template-columns: repeat(5, 1fr);
            gap: 10px; 
            margin: 20px 0;
        }
        .card {
            aspect-ratio: 3/4; 
            background: #f1faee;
            border-radius: 8px; 
            display: flex;
            align-items: center; 
            justify-content: center;
            color: #1d3557; 
            font-weight: bold;
            cursor: pointer; 
            user-select: none;
            transition: all 0.3s; 
            padding: 10px;
            text-align: center; 
            word-break: break-word;
            border: 3px solid transparent;
            font-size: 14px;
        }
        .card:hover { 
            transform: translateY(-5px); 
            border-color: #4cc9f0; 
        }
        /* –¶–≤–µ—Ç–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .card.opened.red { background: #e63946; color: white; }
        .card.opened.blue { background: #457b9d; color: white; }
        .card.opened.black { background: #1d3557; color: white; }
        .card.opened.neutral { background: #f4a261; color: #1d3557; }
        .card.opened { 
            cursor: default; 
            border-color: transparent !important;
        }
        .card.opened:hover { transform: none; }
        
        .controls {
            display: flex; 
            justify-content: center;
            gap: 20px; 
            margin-top: 30px;
        }
        button {
            padding: 12px 30px; 
            border: none;
            border-radius: 25px; 
            background: #7209b7;
            color: white; 
            font-weight: bold;
            cursor: pointer; 
            transition: 0.3s;
        }
        button:hover { background: #560bad; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 10px;
        }
        .team-display {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            min-width: 120px;
        }
        .team-red { background: #e63946; }
        .team-blue { background: #457b9d; }
        
        footer {
            text-align: center; 
            margin-top: 40px;
            color: #6c757d; 
            font-size: 0.9em;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—à–∏–±–∫–∏ */
        .error-container {
            text-align: center;
            padding: 50px 20px;
            background: #16213e;
            border-radius: 10px;
            margin-top: 50px;
        }
        .error-container h2 { color: #e63946; margin-bottom: 20px; }
        .error-container a {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: #7209b7;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üïµÔ∏è Codenames Online</h1>
            <p>–ò–≥—Ä–∞–π—Ç–µ –≤ Codenames —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞</p>
        </header>
        
        <div class="room-info">
            <div>–ö–æ–º–Ω–∞—Ç–∞: <span id="roomDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
            <div id="connectionStatus" class="status">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</div>
        </div>
        
        <!-- –ò–ì–†–û–í–ê–Ø –û–ë–õ–ê–°–¢–¨ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
        <div id="gameArea" style="display: none;">
            <!-- –ë–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–∞–Ω–¥–∞—Ö -->
            <div class="game-info">
                <div class="team-display team-red" id="teamRed">
                    <strong>–ö—Ä–∞—Å–Ω—ã–µ</strong><br>
                    <span id="redCount">9 –æ—Å—Ç–∞–ª–æ—Å—å</span>
                </div>
                <div id="currentTurn">–°–µ–π—á–∞—Å —Ö–æ–¥—è—Ç: <span class="team-red">–ö—Ä–∞—Å–Ω—ã–µ</span></div>
                <div class="team-display team-blue" id="teamBlue">
                    <strong>–°–∏–Ω–∏–µ</strong><br>
                    <span id="blueCount">8 –æ—Å—Ç–∞–ª–æ—Å—å</span>
                </div>
            </div>
            
            <!-- –ò–ì–†–û–í–û–ï –ü–û–õ–ï (25 –∫–∞—Ä—Ç–æ—á–µ–∫) -->
            <div class="board" id="gameBoard">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã JavaScript -->
            </div>
            
            <div class="controls">
                <button id="btnRestart" disabled>–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button id="btnCopyLink">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
            
            <div class="players" id="playerCount">–ò–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω: 1</div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
        <div id="errorContainer" class="error-container" style="display: none;"></div>
        
        <footer>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebSocket ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</p>
        </footer>
    </div>

    <script>
        // ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
        const RENDER_URL = 'codenames-u88n.onrender.com'; // –í–∞—à –¥–æ–º–µ–Ω Render
        
        // ==================== –ü–û–õ–£–ß–ï–ù–ò–ï ID –ö–û–ú–ù–ê–¢–´ ====================
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–Ω–∞—Ç—ã –≤ URL, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        if (!roomId) {
            document.getElementById('errorContainer').innerHTML = `
                <h2>‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã</h2>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –∏–≥—Ä—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram-–±–æ—Ç–µ</p>
                <p>–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:</p>
                <ul style="text-align: left; display: inline-block; margin: 20px;">
                    <li>/start - –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã</li>
                    <li>/new - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</li>
                    <li>/join [–∫–æ–¥] - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</li>
                </ul>
                <p><a href="https://t.me/codenames_raphov_bot" target="_blank">–ü–µ—Ä–µ–π—Ç–∏ –∫ –±–æ—Ç—É</a></p>
            `;
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('roomDisplay').textContent = '–ù–ï–¢ –ö–û–î–ê';
            throw new Error('No room ID in URL');
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–æ–º–Ω–∞—Ç—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º
        roomId = roomId.toUpperCase();
        localStorage.setItem('last_room', roomId);
        document.getElementById('roomDisplay').textContent = roomId;
        
        // ==================== WEBSOCKET –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ====================
        const wsUrl = `wss://${RENDER_URL}/ws?room=${roomId}`;
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let gameData = null;
        let pingInterval = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const statusEl = document.getElementById('connectionStatus');
        const gameArea = document.getElementById('gameArea');
        const gameBoard = document.getElementById('gameBoard');
        const playerCountEl = document.getElementById('playerCount');
        const redCountEl = document.getElementById('redCount');
        const blueCountEl = document.getElementById('blueCount');
        const currentTurnEl = document.getElementById('currentTurn');
        
        function connectWebSocket() {
            statusEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
            statusEl.className = 'status';
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∏–≥—Ä–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É';
                statusEl.className = 'status connected';
                reconnectAttempts = 0;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                pingInterval = setInterval(() => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({action: 'ping'}));
                    }
                }, 30000);
            };
            
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
                }
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                statusEl.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                statusEl.className = 'status error';
            };
            
            socket.onclose = (event) => {
                clearInterval(pingInterval);
                statusEl.textContent = '‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ';
                statusEl.className = 'status error';
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        statusEl.textContent = `–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (${reconnectAttempts}/${maxReconnectAttempts})...`;
                        connectWebSocket();
                    }, 2000 * reconnectAttempts);
                } else {
                    statusEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                }
            };
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –û–¢ –°–ï–†–í–ï–†–ê ====================
        function handleServerMessage(data) {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            switch (data.type) {
                case 'init':
                    // –°–ï–†–í–ï–† –ü–†–ò–°–õ–ê–õ –î–ê–ù–ù–´–ï –ò–ì–†–´ - –°–û–ó–î–ê–Å–ú –ü–û–õ–ï
                    gameData = data;
                    renderGameBoard();
                    updateGameInfo();
                    gameArea.style.display = 'block';
                    break;
                    
                case 'card_opened':
                    // –û–ë–ù–û–í–õ–Ø–ï–ú –û–¢–ö–†–´–¢–£–Æ –ö–ê–†–¢–û–ß–ö–£
                    if (gameData) {
                        gameData.revealed[data.index] = true;
                        gameData.current_team = data.current_team;
                        updateCard(data.index, data.color);
                        updateGameInfo();
                    }
                    break;
                    
                case 'player_joined':
                    playerCountEl.textContent = `–ò–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω: ${data.count}`;
                    break;
                    
                case 'game_over':
                    alert(`üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –ü–æ–±–µ–¥–∏–ª–∏: ${data.winner.toUpperCase()}\n–ü—Ä–∏—á–∏–Ω–∞: ${data.reason}`);
                    break;
                    
                case 'pong':
                    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    break;
            }
        }
        
        // ==================== –°–û–ó–î–ê–ù–ò–ï –ò–ì–†–û–í–û–ì–û –ü–û–õ–Ø ====================
        function renderGameBoard() {
            if (!gameData || !gameData.words) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è');
                return;
            }
            
            gameBoard.innerHTML = '';
            
            // –°–æ–∑–¥–∞—ë–º 25 –∫–∞—Ä—Ç–æ—á–µ–∫
            gameData.words.forEach((word, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.textContent = word;
                card.dataset.index = index;
                
                // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞
                if (gameData.revealed[index]) {
                    card.classList.add('opened');
                    card.classList.add(gameData.colors[index]);
                } else {
                    // –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞ - –º–æ–∂–Ω–æ –∫–ª–∏–∫–∞—Ç—å
                    card.onclick = () => {
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify({
                                action: 'click_card',
                                index: index
                            }));
                        }
                    };
                }
                
                gameBoard.appendChild(card);
            });
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–î–ù–û–ô –ö–ê–†–¢–û–ß–ö–ò ====================
        function updateCard(index, color) {
            const cards = document.querySelectorAll('.card');
            if (cards[index]) {
                cards[index].classList.add('opened', color);
                cards[index].onclick = null; // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            }
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–§–û–†–ú–ê–¶–ò–ò –û–ë –ò–ì–†–ï ====================
        function updateGameInfo() {
            if (!gameData) return;
            
            // –°—á–∏—Ç–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–∞—Ä—Ç–æ—á–∫–∏
            let redLeft = 0;
            let blueLeft = 0;
            
            for (let i = 0; i < 25; i++) {
                if (!gameData.revealed[i]) {
                    if (gameData.colors[i] === 'red') redLeft++;
                    if (gameData.colors[i] === 'blue') blueLeft++;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            redCountEl.textContent = `${redLeft} –æ—Å—Ç–∞–ª–æ—Å—å`;
            blueCountEl.textContent = `${blueLeft} –æ—Å—Ç–∞–ª–æ—Å—å`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–º–∞–Ω–¥—É
            const teamName = gameData.current_team === 'red' ? '–ö—Ä–∞—Å–Ω—ã–µ' : '–°–∏–Ω–∏–µ';
            const teamClass = gameData.current_team === 'red' ? 'team-red' : 'team-blue';
            currentTurnEl.innerHTML = `–°–µ–π—á–∞—Å —Ö–æ–¥—è—Ç: <span class="${teamClass}">${teamName}</span>`;
        }
        
        // ==================== –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –°–°–´–õ–ö–ò ====================
        document.getElementById('btnCopyLink').onclick = () => {
            const link = window.location.href;
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä!\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥—Ä—É–∑—å—è–º –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
            });
        };
        
        // ==================== –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê ====================
        document.getElementById('btnRestart').onclick = () => {
            if (confirm('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É –≤ —ç—Ç–æ–π –∂–µ –∫–æ–º–Ω–∞—Ç–µ?')) {
                location.reload();
            }
        };
        
        // ==================== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ====================
        window.addEventListener('load', () => {
            console.log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ: ${roomId}`);
            console.log(`WebSocket URL: ${wsUrl}`);
            connectWebSocket();
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        window.addEventListener('focus', () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                if (reconnectAttempts < maxReconnectAttempts) {
                    connectWebSocket();
                }
            }
        });
    </script>
</body>
</html>